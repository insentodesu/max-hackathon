# Тестирование backend, бота и фронтенда (Docker)

Все сервисы (backend, чат‑бот и мини‑приложение) запускаются вместе через Docker. Ниже описаны подготовка окружения и ручные проверки.

## Запуск всего стека

### Скрипт

```bash
chmod +x scripts/test-backend-bot.sh
./scripts/test-backend-bot.sh
```

Скрипт:
- выполняет `docker-compose up -d backend bot frontend`;
- ждёт, пока `/health`, `/healthz` и корневая страница фронтенда отвечают;
- внутри backend выполняет `bash ./init_db.sh` (пропускается, если `SKIP_SEED=1`);
- выводит ответы health‑check и результат `docker-compose ps`.

### Вручную

```bash
docker-compose up --build backend bot frontend
docker-compose exec backend bash -lc "bash ./init_db.sh"
```

`init_db.sh` создаёт схему и заполняет демонстрационными данными (университеты, факультеты, студенты, расписания, события, заявки, платежи, рассылки и т.д.).

## Тестовые данные для регистрации в боте

После запуска `./scripts/test-backend-bot.sh` база уже содержит тестовые данные из `backend/seed_*.py`. Ниже перечислены готовые профили — можно взять любого пользователя и пройти регистрацию полностью. Университет и подразделения у всех примеров одинаковые:  
**Московский государственный университет имени М.В. Ломоносова → факультет «Факультет информатики и вычислительной техники» → кафедра «Кафедра информатики» → группа «ИВТ-21-01» (или «ИВТ-21-02» для второго студента).**

### Студенты (роль `student`)
1. **Иванов Иван Иванович**  
   - Университет/факультет/кафедра/группа: см. описание выше.  
   - Город: Москва.  
   - Студенческий билет: `STU001`.
2. **Петров Пётр Петрович**  
   - Те же университет и факультет, группа `ИВТ-21-02`.  
   - Город: Москва.  
   - Студенческий билет: `STU002`.
3. **Сидоров Сидор Сидорович**  
   - Группа `ИВТ-21-01`.  
   - Город: Москва.  
   - Студенческий билет: `STU003`.

### Преподаватели (роль `staff`, ветка преподавателя)
1. **Профессоров Александр Иванович**  
   - Университет и факультет из описания выше, кафедра «Кафедра информатики».  
   - Город: Москва.  
   - Табельный номер: `TCH001`.
2. **Доцентов Сергей Петрович** — та же кафедра, табельный `TCH002`, город Москва.  
3. **Ассистентов Владимир Николаевич** — табельный `TCH003`, город Москва.

### Сотрудники деканата (роль `staff`, ветка административного персонала)
1. **Деканов Иван Петрович**  
   - Университет/факультет/кафедра: как в описании.  
   - Город: Москва.  
   - Табельный номер: `STF001`.
2. **Секретарев Мария Сергеевна** — табельный `STF002`, Москва.  
3. **Администраторов Андрей Николаевич** — табельный `STF003`, Москва.

Чтобы выйти на конкретного пользователя, в боте выбери указанные университет, факультет, кафедру/группу и введи его ФИО вместе с соответствующим номером (студенческий или табельный). Это гарантированно найдёт запись в базе и позволит протестировать весь сценарий регистрации.


## Скрипты для ручек без UI

В `scripts/backend-tools/` лежат утилиты:
- `send_broadcast.py` — вызов `POST /broadcasts`;
- `create_payment.py` — создание платежей;
- `add_student.py` — добавление студента.

Все подробности и переменные окружения описаны в `scripts/backend-tools/README.md`. Тем не менее, Swagger (`http://localhost:8000/docs`) остаётся основным источником схем и примеров.

## Полезные команды

```bash
# Логи
docker-compose logs -f backend
docker-compose logs -f bot
docker-compose logs -f frontend

# Состояние контейнеров
docker-compose ps backend bot frontend

# Повторно наполнить БД
docker-compose exec backend bash -lc "bash ./init_db.sh"

# Остановить всё
docker-compose down
```

## Переменные окружения

```env
# Backend
SECRET_KEY=supersecret
API_V1_PREFIX=/api/v1
DATABASE_URL=sqlite:////data/app.db
STATIC_ROOT=/data/static
STATIC_DIR=/data/static
STATIC_URL=/static
BOT_NOTIFY_BASE_URL=http://bot:8080
BOT_NOTIFY_TOKEN=my-bot-secret
BOT_DEFAULT_SENDER_MAX_ID=1

# YooKassa
YOOKASSA_SHOP_ID=
YOOKASSA_SECRET_KEY=
YOOKASSA_TEST_MODE=true

# Bot service
BOT_TOKEN=<токен Max>
HTTP_BACKEND_TOKEN=my-bot-secret      # должен совпадать с BOT_NOTIFY_TOKEN
LOG_LEVEL=debug
BACKEND_API_BASE_URL=http://backend:8000/api/v1

# Frontend
VITE_API_BASE_URL=http://localhost:8000/api/v1
VITE_API_TOKEN=
```

