# Max Bot

Бот общается с внешним backend-API в `internal/backend`, а также поднимает дополнительное HTTP-API (`/healthz`, `/notify/{userID}`, `/notify/bulk`, `/notify/ready/{userID}`, `/notify/payment/tuition/{userID}`), чтобы внешние сервисы могли отправлять пользователям уведомления.

Основные возможности:
- главное меню и набор команд `/start`, `/help`;
- выбор и оформление типовых заявлений для студентов и преподавателей;
- запрос расписания на сегодня;
- подсказки по платежам (общежитие, обучение, заявки);
- приём уведомлений через REST и доставка их пользователям Max.

## Требования

- Go 1.22+ (в `go.mod` указан 1.25.1; проект успешно собирается более свежим релизом Go);
- токен бота Max (`BOT_TOKEN`);
- Docker (опционально, для контейнерного запуска).

## Переменные окружения

| Переменная | Обязательно | Значение по умолчанию | Описание |
|------------|-------------|-----------------------|----------|
| `BOT_TOKEN` | да | — | Токен бота Max, полученный в админке Max. Используется SDK `github.com/max-messenger/max-bot-api-client-go`. |
| `HTTP_ADDRESS` | нет | `:8080` | Адрес HTTP-сервера (`host:port`) для `/healthz`, `/notify/{userID}`, `/notify/bulk`, `/notify/ready/{userID}` и `/notify/payment/tuition/{userID}`. |
| `HTTP_BACKEND_TOKEN` | нет | — | (Опционально) Секретный токен для защиты HTTP-ручек. Если указан, backend обязан слать `Authorization: Bearer <token>`. Если не задан, доступ ограничивается только сетью (например, через Docker Compose). |
| `LOG_LEVEL` | нет | `info` | Уровень логирования Zerolog (`debug`, `info`, `warn`, ...). |
| `BACKEND_API_BASE_URL` | нет | пусто | Базовый URL backend-API. Если не задан, функции, требующие данных backend, будут недоступны. |

## Локальный запуск

1. Создайте `.env` или экспортируйте переменные окружения, минимум `BOT_TOKEN`:
   ```powershell
   $env:BOT_TOKEN="your-token"
   $env:BACKEND_API_BASE_URL="https://backend.example.com"
   $env:LOG_LEVEL="debug"
   ```
   (в Bash используйте `export`).
2. Запустите бота:
   ```bash
   go run ./cmd/bot
   ```
   или через Makefile:
   ```bash
   LOG_LEVEL=debug BOT_TOKEN=xxx make run
   ```
3. Для сборки бинарника:
   ```bash
   go build -o max-bot ./cmd/bot
   ```

Во время запуска бот подписывается на обновления Max и (если `HTTP_ADDRESS` не пуст) стартует HTTP-сервер. `/healthz` возвращает `{ "status": "ok" }`, POST `/notify/{userID}` принимает тело `{"text":"..."}` и инициирует отправку сообщения пользователю, POST `/notify/bulk` принимает `{"text":"...","sender_id":123,"user_ids":[1,2,3]}` и рассылает то же сообщение сразу нескольким пользователям, POST `/notify/ready/{userID}` запускает сценарий готового документа, а POST `/notify/payment/tuition/{userID}` напоминает про оплату обучения и отправляет пользователю свежую ссылку на платёж. Если задан `HTTP_BACKEND_TOKEN`, backend обязан слать заголовок `Authorization: Bearer $HTTP_BACKEND_TOKEN`, иначе запрос будет отклонён со статусом `401`. Если токен не указан, доступ к POST-ручкам следует ограничить на сетевом уровне (например, приватной Docker Compose-сетью без публикации порта наружу).

## Запуск в Docker

1. Соберите образ:
   ```bash
   docker build -t max-bot .
   ```
2. Запустите контейнер:
```bash
docker run --rm \
  -e BOT_TOKEN=your-token \
  -e BACKEND_API_BASE_URL=https://backend.example.com \
  -e LOG_LEVEL=info \
  -p 8080:8080 \
  max-bot
```

### Docker Compose (рекомендованный подход)

- Создайте приватную сеть (`internal: true`) и подключите к ней bot и backend.
- У сервиса бота вместо `ports` используйте `expose: ["8080"]`, чтобы порт был виден только соседним контейнерам.
- Backend обращается к боту по адресу `http://bot:8080`.
- Frontend/публичные компоненты подключайте к другой сети и не открывайте порт бота наружу.

В этом режиме `HTTP_BACKEND_TOKEN` можно оставить пустым: HTTP-ручки будут доступны только внутри приватной сети. Если же порт пробрасывается наружу (например, через `ports` или отдельный сервер), обязательно задайте токен и передавайте `Authorization: Bearer ...`.

Контейнер запускает статически собранный бинарник (CGO отключён), экспонирует порт `8080` и ожидает переменную `BOT_TOKEN`. Для продакшена добавьте оркестрацию переменных окружения и логирование по стандартному выводу.

## Структура проекта

- `cmd/bot` — точка входа приложения.
- `internal/appbot` — обёртка над клиентом Max и обработчики команд/сообщений.
- `internal/app` — координаторы бизнес-логики (меню, сценарии заявлений, расписание, платежи).
- `internal/backend` — клиенты для внутреннего REST API (заявки, платежи, расписание).
- `internal/httpserver` — лёгкий HTTP-сервер для `/notify`, `/notify/bulk`, `/notify/ready`, `/notify/payment/tuition` и `/healthz`.

Тесты можно запускать командой `go test ./...`.
